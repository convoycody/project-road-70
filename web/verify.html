<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RoadState Verify</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --text:#e6eefc; --muted:#9fb1d6;
      --line:#1c2a45; --good:#35d07f; --bad:#ff5f5f; --warn:#ffcc66;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    .wrap{ max-width:900px; margin:0 auto; padding:18px; }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); margin:12px 0; }
    h1{ margin:8px 0 2px; font-size:20px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      border:1px solid var(--line); background:#0c1526; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .pill{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:var(--muted); }
    .ok{ color:var(--good); }
    .bad{ color:var(--bad); }
    .warn{ color:var(--warn); }
    pre{ background:#0c1526; border:1px solid var(--line); border-radius:12px; padding:10px; overflow:auto; font-family:var(--mono); font-size:12px; }
    .k{ color:var(--muted); }
    a{ color:#69a7ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>RoadState Verify</h1>
          <div class="pill">Tap-to-permit • iPhone Safari • aggregates only</div>
        </div>
        <div class="row">
          <a class="btn" href="/admin">Admin</a>
          <a class="btn" href="/">App</a>
        </div>
      </div>
      <p class="k" style="margin:10px 0 0;">
        If iOS blocks motion: Settings → Safari → Motion & Orientation Access → Allow.
        Also avoid in-app browsers (open in Safari).
      </p>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnPerms" class="btn">Request Motion + Location</button>
        <button id="btnStart" class="btn" disabled>Start</button>
        <button id="btnStop" class="btn" disabled>Stop</button>
        <button id="btnUpload" class="btn" disabled>Upload 60s Aggregate</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:14px;">
        <div><div class="pill">Location</div><div id="locStatus" class="k">not requested</div></div>
        <div><div class="pill">Motion permission</div><div id="permStatus" class="k">not requested</div></div>
        <div><div class="pill">devicemotion events</div><div id="motionStatus" class="k">0</div></div>
        <div><div class="pill">deviceorientation events</div><div id="oriStatus" class="k">0</div></div>
        <div><div class="pill">Last event</div><div id="lastEvt" class="k">never</div></div>
      </div>
    </div>

    <div class="card">
      <div class="pill">Live debug</div>
      <pre id="out">{}</pre>
    </div>
  </div>

<script>
const out = document.getElementById('out');
const locStatus = document.getElementById('locStatus');
const permStatus = document.getElementById('permStatus');
const motionStatus = document.getElementById('motionStatus');
const oriStatus = document.getElementById('oriStatus');
const lastEvt = document.getElementById('lastEvt');

const btnPerms = document.getElementById('btnPerms');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnUpload = document.getElementById('btnUpload');

let watchId = null;
let startedAt = null;

let lastLat = null, lastLon = null;
let lastSpeedMps = null, lastHeading = null;

let motionCount = 0;
let oriCount = 0;

let motionSamples = 0;
let motionEnergy = 0;
let gyroSamples = 0;
let gyroEnergy = 0;

function log(obj){ out.textContent = JSON.stringify(obj, null, 2); }
function set(el, txt, cls){ el.className = cls || 'k'; el.textContent = txt; }

function stampEvent(){
  lastEvt.textContent = new Date().toISOString();
  lastEvt.className = 'ok';
}

function onMotion(ev){
  motionCount++;
  motionStatus.textContent = String(motionCount);
  motionStatus.className = 'ok';
  stampEvent();

  const a = ev.accelerationIncludingGravity || ev.acceleration || {};
  const g = ev.rotationRate || {};
  const ax = (a.x || 0), ay = (a.y || 0), az = (a.z || 0);
  const gx = (g.alpha || 0), gy = (g.beta || 0), gz = (g.gamma || 0);

  motionEnergy += Math.abs(ax) + Math.abs(ay) + Math.abs(az);
  motionSamples++;

  gyroEnergy += Math.abs(gx) + Math.abs(gy) + Math.abs(gz);
  gyroSamples++;
}

function onOrientation(ev){
  oriCount++;
  oriStatus.textContent = String(oriCount);
  oriStatus.className = 'ok';
  stampEvent();
}

async function requestPerms(){
  // Motion permission MUST be requested within a user gesture on iOS
  let motionGranted = false;
  let oriGranted = false;

  try{
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
      motionGranted = ((await DeviceMotionEvent.requestPermission()) === 'granted');
    } else {
      motionGranted = true;
    }
  } catch(e){ motionGranted = false; }

  try{
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
      oriGranted = ((await DeviceOrientationEvent.requestPermission()) === 'granted');
    } else {
      oriGranted = true;
    }
  } catch(e){ oriGranted = false; }

  const anyMotion = motionGranted || oriGranted;
  set(permStatus, anyMotion ? 'granted' : 'blocked', anyMotion ? 'ok' : 'bad');

  // Trigger location prompt
  await new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        set(locStatus, 'granted', 'ok');
        lastLat = pos.coords.latitude;
        lastLon = pos.coords.longitude;
        lastSpeedMps = (typeof pos.coords.speed === 'number') ? pos.coords.speed : null;
        lastHeading = (typeof pos.coords.heading === 'number') ? pos.coords.heading : null;
        resolve();
      },
      (err)=>{
        set(locStatus, 'blocked: ' + err.code, 'bad');
        resolve();
      },
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });

  btnStart.disabled = !(anyMotion && (locStatus.className === 'ok'));
  log({permissions:{motionGranted, oriGranted, location:(locStatus.className==='ok')}});

  // If permissions say granted but we still see no events, that's almost always:
  // - not opened in Safari, or
  // - Safari Motion & Orientation Access is disabled, or
  // - device has no motion sensors available to browser context.
}

function start(){
  startedAt = Date.now();
  motionCount = 0; oriCount = 0;
  motionSamples = 0; motionEnergy = 0;
  gyroSamples = 0; gyroEnergy = 0;

  watchId = navigator.geolocation.watchPosition(
    (pos)=>{
      lastLat = pos.coords.latitude;
      lastLon = pos.coords.longitude;
      lastSpeedMps = (typeof pos.coords.speed === 'number') ? pos.coords.speed : null;
      lastHeading = (typeof pos.coords.heading === 'number') ? pos.coords.heading : null;
      set(locStatus, 'watching', 'ok');
    },
    (err)=> set(locStatus, 'watch error: ' + err.code, 'bad'),
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );

  window.addEventListener('devicemotion', onMotion, {passive:true});
  window.addEventListener('deviceorientation', onOrientation, {passive:true});

  btnStart.disabled = true;
  btnStop.disabled = false;
  btnUpload.disabled = true;

  log({session:'started'});
}

function stop(){
  if (watchId !== null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  window.removeEventListener('devicemotion', onMotion);
  window.removeEventListener('deviceorientation', onOrientation);

  btnStop.disabled = true;
  btnUpload.disabled = false;

  const dur = startedAt ? Math.round((Date.now() - startedAt)/1000) : null;
  log({session:'stopped', duration_seconds:dur, motionCount, oriCount, motionSamples, gyroSamples});
}

async function uploadAggregate(){
  const dur = startedAt ? (Date.now() - startedAt)/1000 : 0;
  if (dur < 50){
    alert('Run at least ~60s before uploading (aggregate-only rule).');
    return;
  }

  const road_roughness = (motionSamples > 0) ? (motionEnergy / motionSamples) : null;

  const payload = {
    received_at: new Date().toISOString().replace('.000','').replace('Z','Z'),
    node_id: "verify-web",
    bucket_start: new Date(Date.now() - 60000).toISOString().replace('.000','').replace('Z','Z'),
    bucket_seconds: 60,
    grid_key: "seg:verify",
    direction: "unknown",
    speed_band: "unknown",
    road_roughness: road_roughness,
    shock_events: 0,
    confidence: 1.0,
    sample_count: motionSamples,
    lat: lastLat,
    lon: lastLon,
    speed_mps: lastSpeedMps,
    heading_deg: lastHeading,
    quality_note: "verify:client_aggregate_only"
  };

  const r = await fetch('/v1/verify/ingest', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify(payload)
  });

  const txt = await r.text();
  if (!r.ok){
    log({upload:'failed', status:r.status, body:txt});
    alert('Upload failed: ' + r.status);
    return;
  }
  log({upload:'ok', response:JSON.parse(txt), payload});
  alert('Uploaded OK');
}

btnPerms.addEventListener('click', requestPerms);
btnStart.addEventListener('click', start);
btnStop.addEventListener('click', stop);
btnUpload.addEventListener('click', uploadAggregate);

log({ready:true});
</script>
</body>
</html>
